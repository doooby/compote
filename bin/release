#!/usr/bin/env bash
-e

git diff --exit-code --quiet
differs=$?
if [ $differs -ne 0 ]; then
    echo "commit changes first"
    #exit 1
fi

IFS='.' read -ra previous_version <<< $(cat VERSION)
next_version=(
    ${previous_version[0]}
    ${previous_version[1]}
    $(( ${previous_version[2]} + 1 ))
)
#previous_version="$( IFS=.; printf '%s' "${previous_version[*]}" )"

major="$( IFS=.; printf '%s' "${next_version[@]:0:2}" )"
minor="$( IFS=.; printf '%s' "${next_version[@]:0:3}" )"

echo "releasing as $minor"
echo "$minor" > VERSION
git commit -a -m "release $minor"

$( git push -f --delete origin "$major" 2&> /dev/null )
git tag "$major"
git tag "$minor"

git push --tags origin "$(git branch --show-current)"
